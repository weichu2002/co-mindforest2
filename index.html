    <script>
        // ================= é…ç½® =================
        const DEFAULT_SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚å›ç­”è¦ä¸“ä¸šã€æ¸…æ™°ï¼Œä½¿ç”¨Markdownæ ¼å¼ã€‚";
        
        // AI APIé…ç½® - ç›´æ¥åœ¨å‰ç«¯è°ƒç”¨
        const DEEPSEEK_API_KEY = "sk-26d09fa903034902928ae380a56ecfd3"; // ä½ çš„API Key
        const DEEPSEEK_API_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
        
        // ESAåä½œAPIç«¯ç‚¹
        const ESA_COLLAB_API = '/api/collab'; // æ ¹æ®esa.config.jsoné…ç½®

        // ================= çŠ¶æ€ =================
        let nodeMap = {}; 
        let rootId = null;
        let activeNodeId = null; 
        let currentChatId = Date.now().toString();
        let branchParentId = null; 
        let chatHistory = JSON.parse(localStorage.getItem('esa_mindforest_history') || '[]');
        let currentFileContent = null;
        let currentFileName = null;
        let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
        let currentRegion = "bj"; 
        let autoGreetingEnabled = true;
        
        // åä½œçŠ¶æ€
        let collaborationRoom = null;
        let userId = generateUserId();
        let userName = "ç”¨æˆ·" + Math.floor(Math.random() * 1000);
        let syncInterval = null;
        let lastSyncTime = 0;

        // ================= å·¥å…·å‡½æ•° =================
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        }
        
        function generateRoomId() {
            return 'room_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36).substr(0, 5);
        }
        
        function getUserColor(userId) {
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 6;
        }

        // ================= åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar();
            
            // æ£€æŸ¥URLæ˜¯å¦æœ‰æˆ¿é—´å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromUrl = urlParams.get('room');
            
            if (roomIdFromUrl) {
                // ä»URLåŠ å…¥æˆ¿é—´
                setTimeout(() => {
                    document.getElementById('room-id-input').value = roomIdFromUrl;
                    showJoinRoomModal();
                }, 500);
            } else if (chatHistory.length > 0) {
                loadChat(chatHistory[0].id);
            } else {
                createNewChat();
            }

            document.getElementById('user-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            });

            window.addEventListener('resize', () => { if(cy) cy.resize(); });
            
            // åˆå§‹åŒ–ç”¨æˆ·åç§°
            const savedName = localStorage.getItem('esa_user_name');
            if (savedName) {
                userName = savedName;
            }
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·ID:', userId);
        });

        // ================= åä½œåŠŸèƒ½ =================
        
        // åˆ›å»ºåä½œæˆ¿é—´
        async function createCollaborationRoom() {
            const roomName = document.getElementById('room-name-input').value || "åä½œæ€ç»´æ ‘";
            const hostName = document.getElementById('host-name-input').value.trim() || "ä¸»æŒäºº";
            
            // ç”Ÿæˆæˆ¿é—´ID
            const roomId = generateRoomId();
            
            // ä¿å­˜ç”¨æˆ·å
            userName = hostName;
            localStorage.setItem('esa_user_name', userName);
            
            // åˆ›å»ºæˆ¿é—´æ•°æ®
            collaborationRoom = {
                id: roomId,
                name: roomName,
                method: 'polling',
                createdBy: userId,
                createdByName: userName,
                createdAt: new Date().toISOString(),
                activeUsers: [{
                    id: userId,
                    name: userName,
                    color: getUserColor(userId),
                    region: currentRegion,
                    joinedAt: new Date().toISOString(),
                    isHost: true
                }]
            };
            
            // åˆ›å»ºå½“å‰æ€ç»´æ ‘çš„å¿«ç…§
            const snapshot = getCurrentSnapshot();
            
            try {
                // è°ƒç”¨ESA APIåˆ›å»ºæˆ¿é—´
                const response = await fetch(ESA_COLLAB_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create_room',
                        roomId: roomId,
                        roomData: collaborationRoom,
                        snapshot: snapshot,
                        userId: userId,
                        userName: userName
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // åˆå§‹åŒ–è½®è¯¢åŒæ­¥
                    initPolling(roomId);
                    
                    // æ›´æ–°UI
                    updateCollaborationUI();
                    
                    // å…³é—­æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
                    closeCreateRoomModal();
                    setTimeout(() => {
                        showShareRoomModal(roomId);
                    }, 300);
                    
                    showNotification(`åä½œæˆ¿é—´ "${roomName}" åˆ›å»ºæˆåŠŸï¼`, 'success');
                } else {
                    const errorText = await response.text();
                    console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', errorText);
                    showNotification('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºæˆ¿é—´é”™è¯¯:', error);
                showNotification('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ å…¥åä½œæˆ¿é—´
        async function joinCollaborationRoom() {
            let roomId = document.getElementById('room-id-input').value.trim();
            const inputUserName = document.getElementById('user-name-input').value.trim() || "åä½œè€…";
            
            // ä»URLä¸­æå–æˆ¿é—´ID
            if (roomId.includes('room=')) {
                const urlParams = new URLSearchParams(roomId.split('?')[1]);
                roomId = urlParams.get('room');
            } else if (roomId.includes('/room/')) {
                roomId = roomId.split('/room/')[1];
            }
            
            // ç®€å•éªŒè¯
            if (!roomId || roomId.length < 5) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆ¿é—´ID', 'error');
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·å
            userName = inputUserName;
            localStorage.setItem('esa_user_name', userName);
            
            try {
                // å…ˆè·å–æˆ¿é—´ä¿¡æ¯
                const infoResponse = await fetch(`${ESA_COLLAB_API}?action=get_room_info&roomId=${roomId}`);
                if (!infoResponse.ok) {
                    throw new Error('æˆ¿é—´ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                }
                
                // è°ƒç”¨ESA APIåŠ å…¥æˆ¿é—´
                const response = await fetch(ESA_COLLAB_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'join_room',
                        roomId: roomId,
                        userId: userId,
                        userName: userName,
                        userData: {
                            id: userId,
                            name: userName,
                            color: getUserColor(userId),
                            region: currentRegion,
                            joinedAt: new Date().toISOString(),
                            isHost: false
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    collaborationRoom = data.room;
                    
                    // åŠ è½½æ€ç»´æ ‘å¿«ç…§
                    if (data.snapshot) {
                        loadRoomSnapshot(data.snapshot);
                    }
                    
                    // åˆå§‹åŒ–è½®è¯¢åŒæ­¥
                    initPolling(roomId);
                    
                    // æ›´æ–°UI
                    updateCollaborationUI();
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    closeJoinRoomModal();
                    
                    showNotification(`å·²åŠ å…¥æˆ¿é—´ "${collaborationRoom.name}"`, 'success');
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é—´é”™è¯¯:', error);
                showNotification('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆå§‹åŒ–è½®è¯¢åŒæ­¥
        function initPolling(roomId) {
            updateRoomStatus('online');
            
            console.log('åˆå§‹åŒ–è½®è¯¢åŒæ­¥ï¼Œæˆ¿é—´:', roomId);
            
            // æ¸…é™¤æ—§çš„è½®è¯¢
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // è®¾ç½®è½®è¯¢é—´éš”
            syncInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${ESA_COLLAB_API}?action=get_updates&roomId=${roomId}&userId=${userId}&lastSync=${lastSyncTime}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('è½®è¯¢æ›´æ–°:', data.updates?.length || 0, 'ä¸ªæ“ä½œ');
                        
                        lastSyncTime = Date.now();
                        
                        if (data.updates && data.updates.length > 0) {
                            data.updates.forEach(update => {
                                console.log('å¤„ç†è¿œç¨‹æ“ä½œ:', update.type, 'æ¥è‡ª:', update.userName);
                                applyRemoteOperation(update);
                            });
                        }
                        
                        if (data.users) {
                            updateUserList(data.users);
                        }
                    } else {
                        console.error('è½®è¯¢å¤±è´¥:', response.status);
                    }
                } catch (error) {
                    console.error('è½®è¯¢é”™è¯¯:', error);
                }
            }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
            document.getElementById('sync-status').classList.remove('hidden');
        }
        
        // å¹¿æ’­èŠ‚ç‚¹æ“ä½œ
        function broadcastNodeOperation(operation) {
            if (!collaborationRoom) return;
            
            const data = {
                ...operation,
                userId: userId,
                userName: userName,
                timestamp: Date.now(),
                color: getUserColor(userId)
            };
            
            console.log('å¹¿æ’­æ“ä½œ:', operation.type, data);
            
            // å‘é€æ“ä½œåˆ°API
            sendOperationToAPI(operation);
        }
        
        // å‘é€æ“ä½œåˆ°API
        async function sendOperationToAPI(operation) {
            if (!collaborationRoom) return;
            
            try {
                const response = await fetch(ESA_COLLAB_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'send_operation',
                        roomId: collaborationRoom.id,
                        userId: userId,
                        operation: operation
                    })
                });
                
                if (!response.ok) {
                    console.error('å‘é€æ“ä½œå¤±è´¥:', await response.text());
                }
            } catch (error) {
                console.error('å‘é€æ“ä½œå¤±è´¥:', error);
            }
        }
        
        // åº”ç”¨è¿œç¨‹æ“ä½œ
        function applyRemoteOperation(data) {
            console.log('åº”ç”¨è¿œç¨‹æ“ä½œ:', data.type, data);
            
            // å¦‚æœæ˜¯è‡ªå·±å‘é€çš„æ“ä½œï¼Œä¸å¤„ç†
            if (data.userId === userId) {
                console.log('å¿½ç•¥è‡ªå·±çš„æ“ä½œ');
                return;
            }
            
            switch (data.type) {
                case 'add_node':
                    // åˆ›å»ºèŠ‚ç‚¹
                    const node = { 
                        id: data.node.id, 
                        parentId: data.node.parentId, 
                        role: data.node.role, 
                        content: data.node.content, 
                        children: [], 
                        timestamp: data.node.timestamp || Date.now(),
                        systemPrompt: data.node.systemPrompt || currentSystemPrompt,
                        region: data.node.region || currentRegion 
                    };
                    
                    console.log('æ·»åŠ èŠ‚ç‚¹:', node.id, 'çˆ¶èŠ‚ç‚¹:', node.parentId, 'è§’è‰²:', node.role);
                    
                    // æ·»åŠ åˆ°nodeMap
                    nodeMap[node.id] = node;
                    
                    // å»ºç«‹çˆ¶å­å…³ç³»
                    if (node.parentId && nodeMap[node.parentId]) {
                        if (!nodeMap[node.parentId].children) {
                            nodeMap[node.parentId].children = [];
                        }
                        if (!nodeMap[node.parentId].children.includes(node.id)) {
                            nodeMap[node.parentId].children.push(node.id);
                        }
                    } else if (!rootId) {
                        // å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹
                        rootId = node.id;
                        console.log('è®¾ç½®æ ¹èŠ‚ç‚¹:', rootId);
                    }
                    break;
                    
                case 'update_node':
                    // æ›´æ–°èŠ‚ç‚¹å†…å®¹
                    if (nodeMap[data.nodeId]) {
                        console.log('æ›´æ–°èŠ‚ç‚¹:', data.nodeId, 'æ–°å†…å®¹:', data.content?.substring(0, 50) + '...');
                        nodeMap[data.nodeId].content = data.content;
                        if (data.systemPrompt !== undefined) {
                            nodeMap[data.nodeId].systemPrompt = data.systemPrompt;
                        }
                    } else {
                        console.warn('æ›´æ–°èŠ‚ç‚¹å¤±è´¥: èŠ‚ç‚¹ä¸å­˜åœ¨', data.nodeId);
                    }
                    break;
                    
                case 'set_active_node':
                    // è®¾ç½®æ´»åŠ¨èŠ‚ç‚¹
                    console.log('è®¾ç½®æ´»åŠ¨èŠ‚ç‚¹:', data.nodeId);
                    activeNodeId = data.nodeId;
                    break;
                    
                case 'update_system_prompt':
                    // æ›´æ–°ç³»ç»Ÿæç¤ºè¯
                    console.log('æ›´æ–°ç³»ç»Ÿæç¤ºè¯:', data.prompt);
                    currentSystemPrompt = data.prompt;
                    break;
                    
                default:
                    console.warn('æœªçŸ¥æ“ä½œç±»å‹:', data.type);
            }
            
            // é‡æ–°æ¸²æŸ“
            console.log('é‡æ–°æ¸²æŸ“... èŠ‚ç‚¹æ•°é‡:', Object.keys(nodeMap).length, 'æ ¹èŠ‚ç‚¹:', rootId, 'æ´»åŠ¨èŠ‚ç‚¹:', activeNodeId);
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            saveCurrentChat();
            
            // é‡æ–°æ¸²æŸ“è§†å›¾
            setTimeout(() => {
                renderStreamView();
                if (cy) {
                    setTimeout(() => initTree(), 100);
                }
            }, 50);
            
            // æ˜¾ç¤ºæ“ä½œé€šçŸ¥
            if (data.userId !== userId && data.userName) {
                showNotification(`${data.userName} æ›´æ–°äº†æ€ç»´æ ‘`, 'info');
            }
        }
        
        // åŠ è½½æˆ¿é—´å¿«ç…§
        function loadRoomSnapshot(snapshot) {
            if (!snapshot) return;
            
            console.log('åŠ è½½æˆ¿é—´å¿«ç…§:', snapshot);
            
            // æ¸…ç©ºå½“å‰çŠ¶æ€
            nodeMap = {};
            rootId = null;
            activeNodeId = null;
            
            // åŠ è½½å¿«ç…§æ•°æ®
            if (snapshot.nodeMap) {
                nodeMap = snapshot.nodeMap;
            }
            
            if (snapshot.rootId) {
                rootId = snapshot.rootId;
            }
            
            if (snapshot.activeNodeId) {
                activeNodeId = snapshot.activeNodeId;
            }
            
            if (snapshot.systemPrompt) {
                currentSystemPrompt = snapshot.systemPrompt;
            }
            
            if (snapshot.region) {
                currentRegion = snapshot.region;
            }
            
            console.log('å¿«ç…§åŠ è½½å®Œæˆï¼ŒèŠ‚ç‚¹æ•°:', Object.keys(nodeMap).length, 'æ ¹èŠ‚ç‚¹:', rootId, 'æ´»åŠ¨èŠ‚ç‚¹:', activeNodeId);
            
            // æ›´æ–°UI
            setTimeout(() => {
                renderStreamView();
                updateRegionDisplay();
            }, 100);
            
            // ä¿å­˜åˆ°å½“å‰å¯¹è¯
            saveCurrentChat();
        }
        
        // è·å–å½“å‰å¿«ç…§
        function getCurrentSnapshot() {
            const snapshot = {
                nodeMap: { ...nodeMap }, // æ·±æ‹·è´èŠ‚ç‚¹æ˜ å°„
                rootId: rootId,
                activeNodeId: activeNodeId,
                systemPrompt: currentSystemPrompt,
                region: currentRegion,
                timestamp: Date.now(),
                version: 1
            };
            
            // æ¸…ç†èŠ‚ç‚¹ä¸­çš„å¾ªç¯å¼•ç”¨
            Object.keys(snapshot.nodeMap).forEach(key => {
                snapshot.nodeMap[key] = { ...snapshot.nodeMap[key] };
            });
            
            console.log('åˆ›å»ºå¿«ç…§ï¼ŒèŠ‚ç‚¹æ•°:', Object.keys(snapshot.nodeMap).length);
            
            return snapshot;
        }
        
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        function updateUserList(users) {
            if (!collaborationRoom) return;
            
            collaborationRoom.activeUsers = users;
            updateActiveUsersList();
        }
        
        // ç¦»å¼€æˆ¿é—´
        async function leaveRoom() {
            if (!collaborationRoom) return;
            
            // æ¸…ç†è½®è¯¢
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            // é€šçŸ¥æœåŠ¡å™¨ç¦»å¼€
            try {
                await fetch(ESA_COLLAB_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'leave_room',
                        roomId: collaborationRoom.id,
                        userId: userId
                    })
                });
            } catch (error) {
                console.error('ç¦»å¼€æˆ¿é—´é”™è¯¯:', error);
            }
            
            // é‡ç½®çŠ¶æ€
            collaborationRoom = null;
            
            // æ›´æ–°UI
            updateCollaborationUI();
            
            showNotification('å·²ç¦»å¼€åä½œæˆ¿é—´', 'info');
        }
        
        // æ›´æ–°åä½œUI
        function updateCollaborationUI() {
            const isInRoom = collaborationRoom !== null;
            
            // æ˜¾ç¤º/éšè—åä½œçŠ¶æ€æ 
            document.getElementById('collaboration-status').classList.toggle('hidden', !isInRoom);
            document.getElementById('collab-badge').classList.toggle('hidden', !isInRoom);
            document.getElementById('sync-status').classList.toggle('hidden', !isInRoom);
            
            if (isInRoom) {
                // æ›´æ–°æˆ¿é—´ä¿¡æ¯
                document.getElementById('room-id-display').textContent = collaborationRoom.id;
                document.getElementById('collab-user-count').textContent = collaborationRoom.activeUsers.length;
                document.getElementById('current-chat-title').textContent = collaborationRoom.name;
                document.getElementById('user-count').textContent = collaborationRoom.activeUsers.length;
                
                // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
                updateActiveUsersList();
                
                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                document.getElementById('region-badge').classList.remove('hidden');
                document.getElementById('current-region-label').textContent = 
                    getRegionLabel(currentRegion).name;
                    
                // æ›´æ–°æˆ¿é—´çŠ¶æ€
                updateRoomStatus('online');
            } else {
                // éšè—åŒºåŸŸæ ‡ç­¾
                document.getElementById('region-badge').classList.add('hidden');
            }
        }
        
        // æ›´æ–°æ´»è·ƒç”¨æˆ·åˆ—è¡¨
        function updateActiveUsersList() {
            if (!collaborationRoom) return;
            
            const listElement = document.getElementById('active-users-list');
            listElement.innerHTML = '';
            
            collaborationRoom.activeUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center justify-between text-xs';
                
                const userInfo = document.createElement('div');
                userInfo.className = 'flex items-center gap-2';
                
                const userAvatar = document.createElement('div');
                userAvatar.className = `user-avatar user-color-${user.color || 0}`;
                userAvatar.textContent = user.name.substring(0, 1);
                
                const userNameSpan = document.createElement('span');
                userNameSpan.className = 'text-slate-300';
                userNameSpan.textContent = user.name;
                
                userInfo.appendChild(userAvatar);
                userInfo.appendChild(userNameSpan);
                
                if (user.isHost) {
                    const hostBadge = document.createElement('span');
                    hostBadge.className = 'text-[10px] bg-purple-900 text-purple-300 px-1.5 py-0.5 rounded';
                    hostBadge.textContent = 'ä¸»æŒäºº';
                    userElement.appendChild(hostBadge);
                }
                
                if (user.id === userId) {
                    const youBadge = document.createElement('span');
                    youBadge.className = 'text-[10px] bg-blue-900 text-blue-300 px-1.5 py-0.5 rounded';
                    youBadge.textContent = 'ä½ ';
                    userElement.appendChild(youBadge);
                }
                
                userElement.appendChild(userInfo);
                listElement.appendChild(userElement);
            });
            
            // æ›´æ–°é¡¶éƒ¨å¾½ç« 
            document.getElementById('collab-user-count').textContent = collaborationRoom.activeUsers.length;
        }
        
        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        function updateRoomStatus(status) {
            const statusElement = document.getElementById('room-status');
            statusElement.textContent = status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
            statusElement.className = `connection-status ${status === 'online' ? 'status-online' : 'status-offline'}`;
        }

        // ================= æ¨¡æ€æ¡†æ§åˆ¶ =================
        function showCreateRoomModal() {
            document.getElementById('create-room-modal').classList.remove('hidden');
        }
        
        function closeCreateRoomModal() {
            document.getElementById('create-room-modal').classList.add('hidden');
        }
        
        function showJoinRoomModal() {
            document.getElementById('join-room-modal').classList.remove('hidden');
        }
        
        function closeJoinRoomModal() {
            document.getElementById('join-room-modal').classList.add('hidden');
        }
        
        function showShareRoomModal(roomId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            document.getElementById('share-room-id').textContent = roomId;
            document.getElementById('share-room-url').value = shareUrl;
            
            document.getElementById('share-room-modal').classList.remove('hidden');
        }
        
        function closeShareRoomModal() {
            document.getElementById('share-room-modal').classList.add('hidden');
        }
        
        // ================= å·¥å…·å‡½æ•° =================
        function copyRoomId() {
            if (collaborationRoom) {
                navigator.clipboard.writeText(collaborationRoom.id)
                    .then(() => showNotification('æˆ¿é—´IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                    .catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
            }
        }
        
        function copyShareUrl() {
            const shareUrl = document.getElementById('share-room-url').value;
            navigator.clipboard.writeText(shareUrl)
                .then(() => showNotification('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                .catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
        }
        
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 animate-slide-up ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle'
                    }"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ================= æ ¸å¿ƒï¼šå…¬å¼æ¸²æŸ“å¼•æ“ =================
        function renderContent(text) {
            if (!text) return "";
            
            const mathMap = {};
            let mathIndex = 0;
            const generateToken = () => `MathToken${Date.now()}_${mathIndex++}_EndToken`;

            const replaceAndStore = (str, regex, wrapperStart = '', wrapperEnd = '') => {
                return str.replace(regex, (match, p1) => {
                    let content = p1 || match;
                    content = content.replace(/\$/g, '');
                    const token = generateToken();
                    mathMap[token] = wrapperStart + content + wrapperEnd;
                    return token;
                });
            };

            let safeText = text;
            safeText = replaceAndStore(safeText, /\\boxed\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/g);
            safeText = replaceAndStore(safeText, /\$\$([\s\S]*?)\$\$/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /\\\[([\s\S]*?)\\\]/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /(\\begin\{[a-z]+\*?\}[\s\S]*?\\end\{[a-z]+\*?\})/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /\\\(([\s\S]*?)\\\)/g, '\\(', '\\)');
            safeText = replaceAndStore(safeText, /(?<!\\)\$([^$\n]+?)(?<!\\)\$/g, '\\(', '\\)');

            let html = marked.parse(safeText);
            Object.keys(mathMap).forEach(token => {
                html = html.replace(token, mathMap[token]);
            });

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            renderMathInElement(tempDiv, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                    {left: '\\begin{align}', right: '\\end{align}', display: true},
                    {left: '\\begin{alignat}', right: '\\end{alignat}', display: true},
                    {left: '\\begin{gather}', right: '\\end{gather}', display: true},
                    {left: '\\begin{CD}', right: '\\end{CD}', display: true},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', 
                strict: false,
                trust: true
            });

            return tempDiv.innerHTML;
        }

        // ================= ESA èŠ‚ç‚¹æ¨¡æ‹Ÿ =================
        function simulateRegionSwitch() {
            const select = document.getElementById('edge-region');
            currentRegion = select.value;
            const latDisplay = document.getElementById('latency-display');
            
            latDisplay.innerHTML = "...";
            latDisplay.parentElement.className = "text-[10px] text-yellow-500 flex items-center gap-1";
            
            setTimeout(() => {
                const latencies = { 'bj': '12ms', 'sg': '45ms', 'fra': '170ms', 'us': '140ms' };
                latDisplay.innerHTML = latencies[currentRegion];
                latDisplay.parentElement.className = "text-[10px] text-green-400 flex items-center gap-1";
                renderStreamView(); 
                if(cy) initTree();
                
                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                if (collaborationRoom) {
                    document.getElementById('current-region-label').textContent = 
                        getRegionLabel(currentRegion).name;
                }
            }, 500);
        }

        function getRegionLabel(code) {
            const map = {
                'bj': { flag: 'ğŸ‡¨ğŸ‡³', name: 'CN-BJ' },
                'sg': { flag: 'ğŸ‡¸ğŸ‡¬', name: 'AP-SG' },
                'fra': { flag: 'ğŸ‡©ğŸ‡ª', name: 'EU-FRA' },
                'us': { flag: 'ğŸ‡ºğŸ‡¸', name: 'US-SV' }
            };
            return map[code] || map['bj'];
        }
        
        function updateRegionDisplay() {
            if (collaborationRoom) {
                document.getElementById('current-region-label').textContent = 
                    getRegionLabel(currentRegion).name;
                document.getElementById('region-badge').classList.remove('hidden');
            }
        }

        // ================= èŠ‚ç‚¹ç®¡ç† =================
        function createNode(role, content, parentId = null, systemPromptSnapshot = null) {
            const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const node = { 
                id, parentId, role, content, 
                children: [], 
                timestamp: Date.now(),
                systemPrompt: systemPromptSnapshot || currentSystemPrompt,
                region: currentRegion 
            };
            nodeMap[id] = node;
            
            // å»ºç«‹çˆ¶å­å…³ç³»
            if (parentId && nodeMap[parentId]) {
                if (!nodeMap[parentId].children) {
                    nodeMap[parentId].children = [];
                }
                nodeMap[parentId].children.push(id);
            } else if (!rootId) {
                // å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹
                rootId = id;
            }
            
            // å¹¿æ’­èŠ‚ç‚¹æ·»åŠ æ“ä½œ
            if (collaborationRoom) {
                broadcastNodeOperation({
                    type: 'add_node',
                    node: node
                });
            }
            
            console.log('åˆ›å»ºèŠ‚ç‚¹:', role, id, 'çˆ¶èŠ‚ç‚¹:', parentId, 'å†…å®¹é•¿åº¦:', content?.length);
            
            return node;
        }

        // ================= è§†å›¾é€»è¾‘ =================
        function renderStreamView() {
            const container = document.getElementById('chat-container');
            container.innerHTML = ''; 
            
            // å¦‚æœæ²¡æœ‰æ´»åŠ¨èŠ‚ç‚¹ä¸”æ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (!activeNodeId && !rootId) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-20"><i class="fa-solid fa-seedling text-4xl mb-4 text-green-300"></i><br>å¼€å§‹ä¸€é¢—æ–°çš„æ€ç»´æ ‘</div>`;
                return;
            }
            
            // å¦‚æœæ²¡æœ‰æ´»åŠ¨èŠ‚ç‚¹ä½†æœ‰æ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨æ ¹èŠ‚ç‚¹
            if (!activeNodeId && rootId) {
                activeNodeId = findDeepestLatestDescendant(rootId);
            }

            const path = getLineage(activeNodeId);
            
            if (path.length === 0) {
                console.warn('æ²¡æœ‰æ‰¾åˆ°èŠ‚ç‚¹è·¯å¾„ï¼Œæ´»åŠ¨èŠ‚ç‚¹:', activeNodeId);
                return;
            }
            
            const lastNode = path[path.length - 1];
            if (lastNode && lastNode.systemPrompt) currentSystemPrompt = lastNode.systemPrompt;
            if (lastNode && lastNode.region) currentRegion = lastNode.region; 

            updateRegionDisplay();

            path.forEach(node => {
                const isUser = node.role === 'user';
                const regInfo = getRegionLabel(node.region || 'bj');
                
                let branchNav = '';
                if (node.parentId) {
                    const parent = nodeMap[node.parentId];
                    if (parent && parent.children && parent.children.length > 1) {
                        const idx = parent.children.indexOf(node.id);
                        if (idx !== -1) {
                            branchNav = `
                                <div class="flex items-center gap-2 text-xs text-gray-400 mb-1 select-none">
                                    <button onclick="switchSibling('${parent.id}', -1, '${node.id}')" class="hover:text-blue-600 p-1"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span>åˆ†æ”¯ ${idx + 1}/${parent.children.length}</span>
                                    <button onclick="switchSibling('${parent.id}', 1, '${node.id}')" class="hover:text-blue-600 p-1"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>`;
                        }
                    }
                }

                const div = document.createElement('div');
                div.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'} animate-slide-up`;
                
                const renderedHtml = renderContent(node.content);
                
                const regionTag = `<div class="absolute -top-3 ${isUser?'right-2':'left-2'} bg-slate-100 border border-slate-200 text-[9px] text-slate-500 px-1.5 rounded-full shadow-sm select-none z-10 flex items-center gap-1">
                    <span>${regInfo.flag}</span> <span class="font-mono">ESA:${regInfo.name}</span>
                </div>`;

                div.innerHTML = `
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[90%] lg:max-w-[80%] group relative mt-4">
                        ${regionTag}
                        ${branchNav}
                        <div class="relative px-5 py-3 rounded-2xl shadow-sm text-sm leading-relaxed ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none'}">
                            <div class="prose prose-sm max-w-none ${isUser?'text-white':''}">${renderedHtml}</div>
                            <div class="absolute -bottom-6 ${isUser ? 'right-0' : 'left-0'} opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="setBranchPoint('${node.id}')" class="text-xs text-gray-400 hover:text-blue-600 flex items-center gap-1 bg-white/80 px-2 py-1 rounded shadow-sm border">
                                    <i class="fa-solid fa-code-branch"></i> åœ¨æ­¤åˆ†å‰
                                </button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function getLineage(endNodeId) {
            const path = [];
            let curr = endNodeId;
            while (curr && nodeMap[curr]) {
                path.unshift(nodeMap[curr]);
                curr = nodeMap[curr].parentId;
            }
            return path;
        }
        
        function switchSibling(parentId, direction, currentNodeId) {
            const parent = nodeMap[parentId];
            if (!parent || !parent.children) return;
            
            const idx = parent.children.indexOf(currentNodeId);
            if (idx === -1) return;
            
            const nextIdx = idx + direction;
            if (nextIdx >= 0 && nextIdx < parent.children.length) {
                activeNodeId = findDeepestLatestDescendant(parent.children[nextIdx]);
                renderStreamView();
                saveCurrentChat();
                
                // å¹¿æ’­æ´»åŠ¨èŠ‚ç‚¹å˜æ›´
                if (collaborationRoom) {
                    broadcastNodeOperation({
                        type: 'set_active_node',
                        nodeId: activeNodeId
                    });
                }
            }
        }
        
        function findDeepestLatestDescendant(nodeId) {
            let curr = nodeMap[nodeId];
            if (!curr) return nodeId;
            
            while(curr.children && curr.children.length > 0) {
                const lastChildId = curr.children[curr.children.length - 1];
                const child = nodeMap[lastChildId];
                if (!child) break;
                curr = child;
            }
            return curr.id;
        }
        
        function setBranchPoint(nodeId) {
            branchParentId = nodeId;
            document.getElementById('branch-indicator').classList.remove('hidden');
            document.getElementById('user-input').focus();
        }
        
        function cancelBranching() {
            branchParentId = null;
            document.getElementById('branch-indicator').classList.add('hidden');
        }

        // ================= å‘é€æ¶ˆæ¯ï¼ˆç›´æ¥è°ƒç”¨AI APIï¼‰ =================
        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            let content = inputEl.value.trim();
            if (!content && !currentFileContent) {
                showNotification('è¯·è¾“å…¥å†…å®¹', 'info');
                return;
            }
            
            inputEl.value = ''; 
            inputEl.style.height = 'auto';

            let displayContent = content; 
            let finalPrompt = content;

            if (currentFileContent) {
                finalPrompt = `ã€æ–‡æ¡£å†…å®¹ã€‘\n${currentFileContent}\n\nã€ç”¨æˆ·æŒ‡ä»¤ã€‘\n${content || "è¯·åˆ†ææ–‡æ¡£"}`;
                displayContent = `ğŸ“‚ [Word] ${currentFileName}\n${content}`;
                clearFile();
            }

            let parentId = branchParentId || activeNodeId;
            let userNode;

            if (!rootId && !parentId) {
                userNode = createNode('user', displayContent, null); 
                activeNodeId = userNode.id;
            } else {
                userNode = createNode('user', displayContent, parentId);
                parentId = userNode.id;
                activeNodeId = userNode.id;
            }
            
            cancelBranching();
            renderStreamView();
            saveCurrentChat();

            const historyNodes = getLineage(parentId);
            const messages = historyNodes.map(n => ({
                role: n.role,
                content: n.id === userNode.id ? finalPrompt : n.content 
            }));
            messages.unshift({ role: "system", content: currentSystemPrompt });

            const container = document.getElementById('chat-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex flex-col items-start animate-slide-up mt-4";
            loadingDiv.innerHTML = `<div class="bg-white border border-gray-100 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm"><div class="flex gap-1 h-5 items-center"><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div></div></div>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const aiNode = createNode('assistant', '', parentId);
                activeNodeId = aiNode.id;

                // ğŸ”¥ ç›´æ¥è°ƒç”¨DeepSeek API
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        model: "deepseek-v3", 
                        messages: messages,
                        stream: false, // ä½¿ç”¨éæµå¼
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                loadingDiv.remove();
                renderStreamView(); 
                
                // æ›´æ–°AIèŠ‚ç‚¹å†…å®¹
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    aiNode.content = data.choices[0].message.content;
                    
                    console.log('AIå›å¤å®Œæˆï¼Œå¹¿æ’­æ›´æ–°');
                    
                    // å¹¿æ’­èŠ‚ç‚¹å†…å®¹æ›´æ–°
                    if (collaborationRoom) {
                        broadcastNodeOperation({
                            type: 'update_node',
                            nodeId: aiNode.id,
                            content: aiNode.content,
                            systemPrompt: currentSystemPrompt
                        });
                    }
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                
                // é‡æ–°æ¸²æŸ“æ˜¾ç¤ºAIå›å¤
                renderStreamView();
                saveCurrentChat();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                loadingDiv.innerHTML = `<div class="text-red-500 px-4 py-2 bg-red-50 rounded border border-red-200">
                    <div class="font-semibold">AIè¯·æ±‚å¤±è´¥</div>
                    <div class="text-sm">${error.message}</div>
                    <div class="text-xs mt-1">è¯·æ£€æŸ¥API Keyæˆ–ç½‘ç»œè¿æ¥</div>
                </div>`;
                
                // åˆ›å»ºé”™è¯¯èŠ‚ç‚¹
                const aiNode = createNode('assistant', 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚', parentId);
                activeNodeId = aiNode.id;
                
                renderStreamView();
                saveCurrentChat();
            }
        }

        // ================= æ ‘çŠ¶å›¾ (Cytoscape) =================
        let cy = null;

        function toggleView() {
            const streamView = document.getElementById('stream-view');
            const treeView = document.getElementById('tree-view');
            const btnText = document.getElementById('view-toggle-text');

            if (streamView.style.opacity === '0' || streamView.style.opacity === '') {
                streamView.style.opacity = '1';
                streamView.style.pointerEvents = 'auto';
                treeView.style.opacity = '0';
                treeView.style.pointerEvents = 'none';
                btnText.innerText = "åˆ‡æ¢æ€ç»´æ ‘è§†å›¾";
            } else {
                streamView.style.opacity = '0';
                streamView.style.pointerEvents = 'none';
                treeView.style.opacity = '1';
                treeView.style.pointerEvents = 'auto';
                btnText.innerText = "è¿”å›å¯¹è¯è§†å›¾";
                setTimeout(() => { initTree(); if (cy) { cy.resize(); cy.fit(); } }, 50);
            }
        }

        function initTree() {
            if (!rootId || Object.keys(nodeMap).length === 0) {
                console.log('æ²¡æœ‰èŠ‚ç‚¹æ•°æ®ï¼Œä¸åˆå§‹åŒ–æ ‘çŠ¶å›¾');
                return;
            }
            
            if (cy) cy.destroy();

            const elements = [];
            Object.values(nodeMap).forEach(node => {
                const label = node.role === 'user' ? 'ğŸ‘¤ ' + (node.content?.substring(0, 10) || '') : 'ğŸ¤– ' + (node.content?.substring(0, 10) || '');
                const safeLabel = label.replace(/\n/g, ' ');
                elements.push({
                    data: { 
                        id: node.id, 
                        label: safeLabel + ((node.content?.length || 0) > 10 ? '...' : ''),
                        fullContent: node.content,
                        role: node.role,
                        region: node.region || 'bj'
                    }
                });
                if (node.parentId && nodeMap[node.parentId]) {
                    elements.push({ data: { source: node.parentId, target: node.id } });
                }
            });

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                wheelSensitivity: 0.05, 
                minZoom: 0.4,
                maxZoom: 1.5,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': ele => ele.data('role') === 'user' ? '#2563eb' : '#ffffff',
                            'label': 'data(label)',
                            'color': ele => ele.data('role') === 'user' ? '#fff' : '#334155',
                            'text-valign': 'center', 'text-halign': 'center',
                            'width': 'label', 'height': 36, 'padding': '12px',
                            'shape': 'round-rectangle',
                            'border-width': 1, 'border-color': '#94a3b8', 'font-size': '12px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: { 'width': 2, 'line-color': '#cbd5e1', 'target-arrow-color': '#cbd5e1', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    {
                        selector: activeNodeId ? `#${activeNodeId}` : '',
                        style: { 'border-color': '#10b981', 'border-width': 3, 'background-color': '#d1fae5', 'color': '#065f46' }
                    }
                ],
                layout: { name: 'breadthfirst', directed: true, padding: 50, spacingFactor: 1.2 }
            });

            cy.on('tap', 'node', function(evt){
                activeNodeId = evt.target.id();
                renderStreamView(); 
                toggleView(); 
                setTimeout(() => {
                    const allBubbles = document.getElementById('chat-container').querySelectorAll('.group');
                    if (allBubbles.length > 0) allBubbles[allBubbles.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                
                // å¹¿æ’­æ´»åŠ¨èŠ‚ç‚¹å˜æ›´
                if (collaborationRoom) {
                    broadcastNodeOperation({
                        type: 'set_active_node',
                        nodeId: activeNodeId
                    });
                }
            });

            cy.on('cxttap', 'node', function(evt){
                showNodeDetail(evt.target.data());
            });
            
            cy.ready(() => cy.fit());
        }

        // ================= å¼¹çª—é€»è¾‘ =================
        function showNodeDetail(nodeData) {
            const modal = document.getElementById('node-detail-modal');
            const contentDiv = document.getElementById('node-detail-content');
            const iconSpan = document.getElementById('detail-role-icon');
            
            if (nodeData.role === 'user') iconSpan.innerHTML = '<i class="fa-solid fa-user text-blue-600"></i>';
            else iconSpan.innerHTML = '<i class="fa-solid fa-robot text-purple-600"></i>';

            contentDiv.innerHTML = renderContent(nodeData.fullContent);
            modal.classList.remove('hidden');
        }

        function closeNodeDetail() {
            document.getElementById('node-detail-modal').classList.add('hidden');
        }

        function copyNodeContent() {
            const content = document.getElementById('node-detail-content').innerText;
            navigator.clipboard.writeText(content).then(() => alert('å·²å¤åˆ¶'));
        }

        function toggleSystemPromptConfig() {
            const modal = document.getElementById('system-prompt-modal');
            const input = document.getElementById('system-prompt-input');
            if (modal.classList.contains('hidden')) {
                input.value = currentSystemPrompt;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function saveSystemPrompt() {
            const val = document.getElementById('system-prompt-input').value.trim();
            if (val) {
                currentSystemPrompt = val;
                
                // å¹¿æ’­ç³»ç»Ÿæç¤ºè¯æ›´æ–°
                if (collaborationRoom) {
                    broadcastNodeOperation({
                        type: 'update_system_prompt',
                        prompt: val
                    });
                }
            }
            toggleSystemPromptConfig();
        }

        // ================= å¯¹è¯ç®¡ç† =================
        function saveCurrentChat() {
            if (!currentChatId) return;
            
            const chatData = { 
                rootId, 
                activeNodeId, 
                nodeMap: {...nodeMap},
                systemPrompt: currentSystemPrompt
            };
            
            localStorage.setItem(`esa_chat_${currentChatId}`, JSON.stringify(chatData));
            const rootNode = nodeMap[rootId];
            const title = rootNode ? (rootNode.content?.substring(0, 10) || "æ–°å¯¹è¯") + "..." : "æ–°å¯¹è¯";
            const existingIndex = chatHistory.findIndex(c => c.id === currentChatId);
            if (existingIndex >= 0) {
                chatHistory[existingIndex].title = title;
                chatHistory[existingIndex].timestamp = Date.now();
            } else {
                chatHistory.unshift({ id: currentChatId, title, timestamp: Date.now() });
            }
            localStorage.setItem('esa_mindforest_history', JSON.stringify(chatHistory));
            loadSidebar();
            document.getElementById('current-chat-title').innerText = title;
        }
        
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (!file.name.endsWith('.docx')) { alert('ä»…æ”¯æŒ .docx'); return; }
            const preview = document.getElementById('file-preview');
            preview.classList.remove('hidden');
            document.getElementById('file-name').innerText = file.name;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                currentFileContent = result.value;
            } catch (e) { alert("è§£æå¤±è´¥"); }
        }
        
        function clearFile() {
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview').classList.add('hidden');
            currentFileContent = null;
        }
        
        function loadSidebar() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            chatHistory.forEach(chat => {
                const item = document.createElement('div');
                item.className = `p-3 rounded cursor-pointer transition-colors flex justify-between group text-sm mb-1 ${chat.id === currentChatId ? 'bg-slate-800' : 'hover:bg-slate-800'}`;
                item.innerHTML = `<div class="truncate flex-1" onclick="loadChat('${chat.id}')">${chat.title}</div><button onclick="deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400 ml-2"><i class="fa-solid fa-trash"></i></button>`;
                listEl.appendChild(item);
            });
        }
        
        function createNewChat() {
            currentChatId = Date.now().toString();
            nodeMap = {}; rootId = null; activeNodeId = null; branchParentId = null;
            currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
            autoGreetingEnabled = true;
            
            document.getElementById('chat-container').innerHTML = `<div class="text-center text-gray-400 mt-20"><i class="fa-solid fa-seedling text-4xl mb-4 text-green-300"></i><br>å¼€å§‹ä¸€é¢—æ–°çš„æ€ç»´æ ‘</div>`;
            document.getElementById('current-chat-title').innerText = "æ–°å¯¹è¯";
            
            if (document.getElementById('stream-view').style.opacity === '0') toggleView();
            loadSidebar();
            
            // è‡ªåŠ¨å‘é€"ä½ å¥½"
            setTimeout(() => {
                if (autoGreetingEnabled) {
                    document.getElementById('user-input').value = 'ä½ å¥½';
                    sendMessage();
                }
            }, 500);
        }
        
        function loadChat(chatId) {
            const dataStr = localStorage.getItem(`esa_chat_${chatId}`);
            if (!dataStr) return;
            const data = JSON.parse(dataStr);
            currentChatId = chatId; 
            nodeMap = data.nodeMap; 
            rootId = data.rootId; 
            activeNodeId = data.activeNodeId;
            currentSystemPrompt = data.systemPrompt || DEFAULT_SYSTEM_PROMPT;
            autoGreetingEnabled = false;
            
            const hist = chatHistory.find(c => c.id === chatId);
            if(hist) document.getElementById('current-chat-title').innerText = hist.title;
            
            renderStreamView(); 
            loadSidebar();
            if (document.getElementById('stream-view').style.opacity === '0') initTree();
        }
        
        function deleteChat(chatId, event) {
            event.stopPropagation();
            if(!confirm("åˆ é™¤?")) return;
            localStorage.removeItem(`esa_chat_${chatId}`);
            chatHistory = chatHistory.filter(c => c.id !== chatId);
            localStorage.setItem('esa_mindforest_history', JSON.stringify(chatHistory));
            if (currentChatId === chatId) createNewChat(); else loadSidebar();
        }
        
        // ================= è°ƒè¯•åŠŸèƒ½ =================
        function debugState() {
            console.log('=== è°ƒè¯•çŠ¶æ€ ===');
            console.log('åä½œæˆ¿é—´:', collaborationRoom);
            console.log('èŠ‚ç‚¹æ•°é‡:', Object.keys(nodeMap).length);
            console.log('æ ¹èŠ‚ç‚¹:', rootId);
            console.log('æ´»åŠ¨èŠ‚ç‚¹:', activeNodeId);
            console.log('ç”¨æˆ·ID:', userId);
            console.log('nodeMap:', nodeMap);
            
            // æ˜¾ç¤ºèŠ‚ç‚¹æ ‘
            function printNodeTree(nodeId, depth = 0) {
                const node = nodeMap[nodeId];
                if (!node) return;
                
                const indent = '  '.repeat(depth);
                console.log(`${indent}${node.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'} ${node.id}: ${node.content?.substring(0, 30)}...`);
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(childId => printNodeTree(childId, depth + 1));
                }
            }
            
            if (rootId) {
                console.log('èŠ‚ç‚¹æ ‘:');
                printNodeTree(rootId);
            }
        }
    </script>
</body>
</html>
